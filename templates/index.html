
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captcha Solver Pro Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        :root {
            --bg-main: #0c0c0e;
            --card-bg: #141417;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.15);
            --border: rgba(255, 255, 255, 0.06);
            --text-muted: #71717a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-main);
            color: #ececec;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .main-container {
            width: 100%;
            max-width: 600px; 
            padding: 1.5rem;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .captcha-container {
            position: relative;
            height: 280px; 
            background: #000;
            margin: 0 1.5rem;
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #captcha-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 1rem;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.1));
            image-rendering: pixelated;
        }

        .control-section {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 0.6rem 0.6rem 0.6rem 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 340px; 
        }

        .input-group:focus-within {
            border-color: var(--accent);
            background: rgba(16, 185, 129, 0.02);
            box-shadow: 0 0 0 1px var(--accent);
        }

        .custom-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 1.75rem; 
            font-weight: 700;
            color: white;
            text-align: center;
            outline: none;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.2em;
            width: 100%;
        }

        .send-button {
            width: 44px; 
            height: 44px;
            background: var(--accent);
            color: #000;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .toolbar {
            display: flex;
            gap: 0.75rem;
            width: 100%;
            max-width: 340px;
        }

        .tool-btn {
            flex: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            padding: 0.6rem;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-muted);
            transition: all 0.2s;
            letter-spacing: 0.05em;
        }

        .alarm-on { color: var(--accent); border-color: rgba(16, 185, 129, 0.2); }
        .alarm-off { color: #ef4444; border-color: rgba(239, 68, 68, 0.2); }

        .tool-btn.active {
            background: #ef4444;
            color: white;
            border-color: transparent;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .header-main {
            padding: 1.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-box h1 {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.03);
            padding: 0.25rem 0.6rem;
            border-radius: 2rem;
            border: 1px solid var(--border);
            margin-top: 0.5rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.active {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .status-text {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-badge {
            background: rgba(255,255,255,0.03);
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .info-label {
            display: block;
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .info-value {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }

        #audio-guard {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .guard-btn {
            background: white;
            color: black;
            padding: 1rem 2rem;
            border-radius: 100px;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .guard-btn:hover { transform: scale(1.05); }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
    </style>
</head>
<body>

    <div id="audio-guard">
        <button onclick="unlockAudio()" class="guard-btn">KHỞI ĐỘNG HỆ THỐNG</button>
    </div>

    <div class="main-container">
        <div class="glass-card">
            <div class="header-main">
                <div class="brand-box">
                    <h1>SOLVER<span style="color:var(--accent)">PRO</span></h1>
                    <div class="status-pill">
                        <span id="dot" class="status-dot"></span>
                        <span id="status-text" class="status-text">ĐANG CHỜ TÍN HIỆU</span>
                    </div>
                </div>
                
                <div class="text-right">
                    <span class="info-label">Hàng đợi</span>
                    <span id="queue-count" class="text-3xl font-bold text-white tabular-nums">0</span>
                </div>
            </div>

            <div class="captcha-container">
                <img id="captcha-img" src="" class="hidden">
                <div id="placeholder" class="text-center opacity-30">
                    <div class="w-12 h-12 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <p class="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-500">Đang đợi Captcha</p>
                </div>
            </div>

            <div class="control-section">
                <div class="w-full flex flex-col items-center">
                    <div class="input-group">
                        <input type="number" id="answer-input" class="custom-input" placeholder="0000" autocomplete="off">
                        <button id="send-btn" onclick="submitAnswer()" class="send-button">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="last-result" class="mt-3 opacity-0 transition-opacity">
                        <span class="text-[9px] font-bold text-zinc-600 uppercase tracking-widest">Gần nhất: </span>
                        <span id="last-val" class="text-[9px] font-mono text-emerald-500 font-bold">----</span>
                    </div>
                </div>

                <div class="toolbar">
                    <button id="mic-btn" class="tool-btn">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z"></path><path d="M3 8a1 1 0 00-1 1v1a8 8 0 007 7.931V19a1 1 0 102 0v-1.069A8.001 8.001 0 0018 10V9a1 1 0 10-2 0v1a6 6 0 01-12 0V9a1 1 0 00-1-1z"></path></svg>
                        GIỌNG NÓI (M)
                    </button>
                    <button id="alarm-toggle" onclick="toggleSound()" class="tool-btn alarm-off">
                        CHUÔNG: TẮT
                    </button>
                </div>
            </div>

            <div class="px-6 py-4 bg-white/[0.02] border-t border-white/[0.05] flex gap-4">
                <div class="info-badge flex-1">
                    <span class="info-label">ID Nhiệm vụ</span>
                    <span id="job-id-text" class="info-value">KHÔNG CÓ</span>
                </div>
                <div class="info-badge flex-1 text-right">
                    <span class="info-label">Trạng thái</span>
                    <span id="app-mode" class="info-value">ĐANG CHỜ</span>
                </div>
            </div>
        </div>
    </div>

    <audio id="alert-sound" src="/static/alert.mp3" loop preload="auto"></audio>

    <script>
        const socket = io();
        let currentJobId = null;
        let isSoundOn = localStorage.getItem('solver_sound_pro') === 'true';
        let isAlertPlaying = false;
        let isHoldingM = false;

        const audio = document.getElementById('alert-sound');
        const input = document.getElementById('answer-input');
        const img = document.getElementById('captcha-img');
        const placeholder = document.getElementById('placeholder');
        const queueCount = document.getElementById('queue-count');
        const micBtn = document.getElementById('mic-btn');
        const alarmBtn = document.getElementById('alarm-toggle');
        const statusText = document.getElementById('status-text');
        const dot = document.getElementById('dot');
        const appMode = document.getElementById('app-mode');
        const jobIdText = document.getElementById('job-id-text');
        const lastResult = document.getElementById('last-result');
        const lastVal = document.getElementById('last-val');

        function unlockAudio() {
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                document.getElementById('audio-guard').style.display = 'none';
            }).catch(() => {});
        }

        function updateSoundUI() {
            if (isSoundOn) {
                alarmBtn.innerText = 'CHUÔNG: BẬT';
                alarmBtn.className = 'tool-btn alarm-on';
            } else {
                alarmBtn.innerText = 'CHUÔNG: TẮT';
                alarmBtn.className = 'tool-btn alarm-off';
            }
        }
        updateSoundUI();

        socket.on('update_state', (data) => {
            queueCount.innerText = data.queue_size;
            
            if (isSoundOn && (data.queue_size > 0 || data.active_id)) {
                if (!isAlertPlaying) {
                    audio.play().then(() => { isAlertPlaying = true; }).catch(() => {});
                }
            } else {
                audio.pause(); audio.currentTime = 0; isAlertPlaying = false;
            }

            if (data.active_id && data.active_url) {
                currentJobId = data.active_id;
                img.src = data.active_url + "?t=" + new Date().getTime();
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
                
                statusText.innerText = "ĐÃ NHẬN CAPTCHA";
                statusText.style.color = "var(--accent)";
                dot.className = "status-dot active";
                appMode.innerText = "ĐANG XỬ LÝ";
                jobIdText.innerText = data.active_id.substring(0,8).toUpperCase();
                
                if (!isHoldingM) {
                    setTimeout(() => input.focus(), 100);
                }
            } else {
                currentJobId = null;
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
                
                statusText.innerText = "ĐANG CHỜ TÍN HIỆU";
                statusText.style.color = "var(--text-muted)";
                dot.className = "status-dot";
                appMode.innerText = "ĐANG CHỜ";
                jobIdText.innerText = "KHÔNG CÓ";
                input.value = "";
            }
        });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.onstart = () => micBtn.classList.add('active');
            recognition.onend = () => { micBtn.classList.remove('active'); isHoldingM = false; if (currentJobId) input.focus(); };
            recognition.onresult = (e) => {
                const val = e.results[0][0].transcript.replace(/[^0-9]/g, '');
                if (val) { input.value = val; submitAnswer(); }
            };
        }

        function startMic() { if (recognition && !isHoldingM) { isHoldingM = true; input.blur(); recognition.start(); } }
        
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'm') { e.preventDefault(); startMic(); }
            else if (/[0-9]/.test(e.key) && document.activeElement !== input) { input.focus(); }
        });

        document.addEventListener('keyup', (e) => { 
            if (e.key.toLowerCase() === 'm' && recognition) recognition.stop(); 
        });

        function toggleSound() {
            isSoundOn = !isSoundOn;
            localStorage.setItem('solver_sound_pro', isSoundOn);
            updateSoundUI();
            if (!isSoundOn) { audio.pause(); isAlertPlaying = false; }
        }

        function submitAnswer() {
            const val = input.value;
            if (!currentJobId || !val) return;
            
            lastVal.innerText = val;
            lastResult.style.opacity = "1";
            setTimeout(() => { lastResult.style.opacity = "0"; }, 2000);

            fetch('/submit_answer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: currentJobId, answer: val})
            });
            input.value = "";
        }

        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') submitAnswer(); });
    </script>
</body>
</html>